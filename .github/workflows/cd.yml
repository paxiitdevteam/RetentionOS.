name: CD

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      # Build Backend
      - name: Build Backend
        working-directory: ./backend
        run: |
          npm ci
          npm run build
      
      # Build Dashboard
      - name: Build Dashboard
        working-directory: ./frontend/dashboard
        run: |
          npm ci
          npm run build
      
      # Build Widget
      - name: Build Widget
        working-directory: ./frontend/widget
        run: |
          npm ci
          npm run build
      
      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp -r backend/dist deployment/backend
          cp -r frontend/dashboard/.next deployment/dashboard
          cp -r frontend/widget/build deployment/widget
          cp -r infra deployment/infra
          cp -r docs deployment/docs
          tar -czf retentionos-deployment.tar.gz deployment/
      
      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: retentionos-deployment.tar.gz
          retention-days: 30
      
      # Docker build (optional - uncomment when ready)
      # - name: Build Docker images
      #   run: |
      #     docker build -t retentionos-backend:latest ./backend
      #   
      # - name: Push to Docker Registry
      #   if: startsWith(github.ref, 'refs/tags/v')
      #   run: |
      #     echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      #     docker tag retentionos-backend:latest ${{ secrets.DOCKER_REGISTRY }}/retentionos-backend:${{ github.ref_name }}
      #     docker push ${{ secrets.DOCKER_REGISTRY }}/retentionos-backend:${{ github.ref_name }}

